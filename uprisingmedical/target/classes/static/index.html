<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uprising Medical - Connecting Engineers to Medical Innovation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #0a1a2f; color: #e0e6f0; overflow-x: hidden; }
        nav { background: rgba(15, 25, 40, 0.95); position: sticky; top: 0; z-index: 1000; padding: 1rem 0; }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; }
        .logo { font-size: 1.5rem; font-weight: bold; background: linear-gradient(45deg, #667eea, #764ba2);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .nav-links { display: flex; list-style: none; gap: 1.5rem; }
        .nav-links a { text-decoration: none; color: #e0e6f0; padding: 0.5rem 1rem; border-radius: 6px; transition: background 0.3s ease; }
        .nav-links a:hover { background: rgba(102, 126, 234, 0.2); }
        .mobile-menu { display: none; flex-direction: column; cursor: pointer; }
        .mobile-menu span { width: 25px; height: 3px; background: #e0e6f0; margin: 4px 0; }
        .content-section { display: none; padding: 3rem 1rem; }
        .content-section.active { display: block; }
        .hero { height: 90vh; display: flex; align-items: center; justify-content: center; text-align: center;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin: 2rem auto;
                max-width: 1000px; padding: 2rem; }
        .hero h1 { font-size: 3rem; color: #fff; margin-bottom: 1rem; }
        .hero p { font-size: 1.3rem; color: #e0e6f0; }
        .stat-card, .about-card, .team-member { background: #1b2b47; border: 1px solid #33415c; border-radius: 12px;
                padding: 1.5rem; margin: 1rem 0; }
        #problemForm input, #problemForm textarea, #problemForm select, #signupForm input, #signupForm select, #loginForm input {
            padding: 0.7rem; border-radius: 6px; border: 1px solid #33415c; background: #1b2b47; color: #e0e6f0; font-size: 1rem;
        }
        button { background: #4a90e2; border: none; color: white; padding: 0.75rem; border-radius: 6px; cursor: pointer; }
        button:hover { background: #3578d4; }
        footer { background: #081526; color: #cdd6e5; text-align: center; padding: 2rem 0; margin-top: 3rem; }
        @media (max-width: 768px) {
            .nav-links { display: none; flex-direction: column; background: #0a1a2f; width: 100%; position: absolute; top: 60px; left: 0; padding: 1rem; }
            .mobile-menu { display: flex; }
        }
    </style>
    
</head>
<body>
<nav>
    <div class="nav-container">
        <div class="logo">Uprising Medical</div>
        <ul class="nav-links">
            <li><a href="#" onclick="showSection('home')">Home</a></li>
            <li><a href="#" onclick="showSection('about')">About</a></li>
            <li><a href="#" onclick="showSection('challenges')">Challenges</a></li>
            <li><a href="#" onclick="showSection('submit')">Submit a Problem</a></li>
            <li><a href="#" onclick="showSection('teams')">Teams</a></li>
            <li><a href="#" onclick="showSection('login')">Login</a></li>
            <li><a href="#" onclick="showSection('signup')">Sign Up</a></li>
            <li id="adminNav" style="display:none;">
                <a href="#" onclick="showSection('admin'); loadPendingProblems();">Admin</a>
            </li>
        </ul>
        <div class="mobile-menu" onclick="toggleMenu()"><span></span><span></span><span></span></div>
    </div>
</nav>

<section id="home" class="content-section active">
    <div class="hero">
        <div>
            <h1>Uprising Medical</h1>
            <p>Connecting Engineers to Solve Real-World Medical Challenges</p>
            <button onclick="showSection('submit')">Submit a Problem</button>
        </div>
    </div>
</section>

<section id="about" class="content-section">
    <div class="about-card">
        <h2>Our Mission</h2>
        <p>We connect medical professionals with engineering students to solve healthcare challenges.</p>
    </div>
</section>

<section id="submit" class="content-section">
    <h2 style="text-align:center; color:#4a90e2; margin-bottom:1rem;">Submit a Problem</h2>
    <form id="problemForm" style="
        max-width: 500px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #1b2b47;
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid #33415c;
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    ">
        <input type="text" id="title" placeholder="Problem Title" required style="
            padding:0.7rem;
            border-radius:6px;
            border:1px solid #33415c;
            background:#101c36;
            color:#e0e6f0;
            font-size:1rem;
        ">
        <textarea id="description" placeholder="Describe the problem..." rows="5" required style="
            padding:0.7rem;
            border-radius:6px;
            border:1px solid #33415c;
            background:#101c36;
            color:#e0e6f0;
            font-size:1rem;
        "></textarea>
        <select id="category" required style="
            padding:0.7rem;
            border-radius:6px;
            border:1px solid #33415c;
            background:#101c36;
            color:#e0e6f0;
            font-size:1rem;
        ">
            <option value="">Select a category</option>
            <option value="Diagnostics">Diagnostics</option>
            <option value="Prosthetics">Prosthetics</option>
            <option value="Software">Software</option>
            <option value="Medical Device">Medical Device</option>
        </select>
        <button type="submit" style="
            background: linear-gradient(45deg, #4a90e2, #6a5acd);
            color:white;
            padding:0.8rem;
            border:none;
            border-radius:6px;
            cursor:pointer;
            font-size:1rem;
            transition:all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-2px)'" 
           onmouseout="this.style.transform='translateY(0)'">
            Submit Problem
        </button>
    </form>
    <p id="formMessage" style="text-align:center; margin-top:1rem; color:#cdd6e5;"></p>
</section>

<section id="challenges" class="content-section">
    <h2 style="text-align:center;">Open Challenges</h2>
    <div id="challengesList"></div>
</section>

<!-- Admin Page -->
<section id="admin" class="content-section">
    <h2 style="text-align:center;">Admin Panel</h2>

    <!-- Create Team -->
    <div style="max-width:500px; margin:2rem auto; background:#1b2b47; padding:1.5rem; border-radius:12px; border:1px solid #33415c;">
        <h3 style="color:#4a90e2;">Create a New Team</h3>
        <form id="createTeamForm" style="display:flex; flex-direction:column; gap:1rem; margin-top:1rem;">
            <input type="text" id="teamNameCreate" placeholder="Team Name" required>
            <textarea id="teamDescCreate" placeholder="Describe your team..." rows="3"></textarea>
            <button type="submit" style="background:#4a90e2; color:white; padding:0.7rem; border:none; border-radius:6px;">Create Team</button>
        </form>
        <p id="createTeamMessage" style="text-align:center; margin-top:1rem;"></p>
    </div>

    <!-- Pending Join Requests -->
    <div style="max-width:700px; margin:2rem auto;">
        <h3 style="color:#4a90e2;">Pending Join Requests</h3>
        <div id="joinRequests" style="display:flex; flex-direction:column; gap:1rem; margin-top:1rem;">
            <!-- Requests will be loaded dynamically -->
        </div>
    </div>

    <!-- Pending Problem Approvals -->
    <div style="max-width:700px; margin:2rem auto;">
        <h3 style="color:#4a90e2;">Pending Problem Approvals</h3>
        <div id="pendingProblems" style="display:flex; flex-direction:column; gap:1rem; margin-top:1rem;">
            <!-- Problems will be loaded dynamically -->
        </div>
    </div>

</section>

<section id="signup" class="content-section">
  <h2 style="text-align:center;">Sign Up</h2>
  <form id="signupForm">
    <input type="text" id="signupUsername" placeholder="Username" required>
    <input type="password" id="signupPassword" placeholder="Password" required>

    <select id="signupRole" required>
      <option value="">Select Role</option>
      <option value="STUDENT">Student</option>
      <option value="ADMIN">Admin</option>
    </select>

    <!-- Shown only when role = ADMIN -->
    <input type="password" id="signupAdminCode"
           placeholder="Admin Code"
           style="display:none;">
    <button type="submit">Sign Up</button>
  </form>
  <p id="signupMessage" style="text-align:center; margin-top:1rem;"></p>
</section>


<section id="teams" class="content-section">
    <h2 style="text-align:center;">Available Teams</h2>
    <div id="teamsList" style="max-width:600px; margin:auto; display:flex; flex-direction:column; gap:1rem;">
        <!-- Teams will be loaded dynamically -->
    </div>
</section>

<section id="login" class="content-section">
    <h2 style="text-align:center;">Login</h2>
    <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
    <p id="loginMessage" style="text-align:center; margin-top:1rem;"></p>
</section>

<footer><p>&copy; 2025 Uprising Medical</p></footer>

<script>
// Navigation
function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.getElementById(sectionId)?.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });

  if (sectionId === 'challenges') loadChallenges();
  if (sectionId === 'teams') loadTeams();
  if (sectionId === 'admin') { loadPendingProblems(); loadJoinRequests(); }
}

document.addEventListener('DOMContentLoaded', () => {
  loadChallenges(); // warm cache
});



// Submit Problem
// Submit Problem
document.getElementById("problemForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = e.submitter || e.target.querySelector("button[type=submit]");
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const category = document.getElementById("category").value;
  const msg = document.getElementById("formMessage");

  if (!title || !description || !category) { msg.textContent = "Please fill all fields."; return; }

  btn.disabled = true; btn.textContent = "Submitting…"; msg.textContent = "";

  try {
    const res = await fetch("http://localhost:8080/problems", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, description, category })
    });
    if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
    msg.textContent = "Submitted! Awaiting admin approval.";
    e.target.reset();
    // optional refresh
    typeof loadPendingProblems === "function" && loadPendingProblems();
    typeof loadChallenges === "function" && loadChallenges();
  } catch (err) {
    console.error(err);
    msg.textContent = "Submission failed. See console.";
  } finally {
    btn.disabled = false; btn.textContent = "Submit Problem";
  }
});

// Load Challenges
async function loadChallenges() {
    const container = document.getElementById("challengesList");
    container.innerHTML = "<p>Loading challenges...</p>";
    try {
        const res = await fetch("http://localhost:8080/problems");
        const problems = await res.json();
        container.innerHTML = problems.length === 0
            ? "<p>No approved challenges yet.</p>"
            : problems.map(p => `
                <div style="background:#1b2b47; padding:1rem; border-radius:8px; border:1px solid #33415c;">
                    <h3 style="color:#4a90e2;">${p.title}</h3>
                    <p>${p.description}</p>
                    <small style="color:#cdd6e5;">Category: ${p.category}</small>
                </div>`).join("");
    } catch {
        container.innerHTML = "<p style='color:red;'>Error loading challenges.</p>";
    }
}

// Load Pending Problems
async function loadPendingProblems() {
    const container = document.getElementById("pendingProblems");
    container.innerHTML = "<p>Loading pending problems...</p>";
    try {
        const res = await fetch("http://localhost:8080/problems/pending");
        const problems = await res.json();
        container.innerHTML = problems.length === 0
            ? "<p>No pending problems.</p>"
            : "";
        problems.forEach(p => {
            const card = document.createElement("div");
            card.style = "padding:1rem; margin:1rem 0; border:1px solid #33415c; background:#1b2b47; border-radius:8px;";
            card.innerHTML = `
                <h3>${p.title}</h3>
                <p><strong>Category:</strong> ${p.category}</p>
                <p>${p.description}</p>
                <button onclick="approveProblem(${p.id})">Approve</button>`;
            container.appendChild(card);
        });
    } catch {
        container.innerHTML = "<p style='color:red;'>Error loading pending problems.</p>";
    }
}

// Approve Problem
async function approveProblem(id) {
    try {
        const res = await fetch(`http://localhost:8080/problems/${id}/approve`, { method: "PATCH" });
        if (res.ok) {
            alert("Problem approved!");
            loadPendingProblems();
            loadChallenges();
        } else {
            alert("Failed to approve problem.");
        }
    } catch {
        alert("Error approving problem.");
    }
}

// Sign Up
// Show/hide Admin Code based on role
document.getElementById("signupRole").addEventListener("change", (e) => {
  const adminCodeInput = document.getElementById("signupAdminCode");
  adminCodeInput.style.display = e.target.value === "ADMIN" ? "block" : "none";
  if (e.target.value !== "ADMIN") adminCodeInput.value = "";
});

// Submit handler
document.getElementById("signupForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = {
    username: signupUsername.value.trim(),
    password: signupPassword.value,
    role: signupRole.value,
    adminCode: signupRole.value === "ADMIN" ? signupAdminCode.value : null
  };
  const res = await fetch("/auth/register", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const text = await res.text();
  signupMessage.textContent = res.ok ? text : text || "Error creating account.";
  // do NOT auto-login unless you want to
});


// Login
document.getElementById("loginForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;
    try {
        const res = await fetch("http://localhost:8080/auth/login", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ username, password })
        });
        const text = await res.text();
        if (res.ok) {
              document.getElementById("loginMessage").textContent = text;
            // ✅ persist who is logged in so requests know the username
            localStorage.setItem("username", username);
            localStorage.setItem("role", text.includes("ADMIN") ? "ADMIN" : "STUDENT");
            if (text.includes("ADMIN")) {
                document.getElementById("adminNav").style.display = "inline-block";
        }
            
        } else {
            document.getElementById("loginMessage").textContent = "Invalid username or password.";
        }
    } catch {
        document.getElementById("loginMessage").textContent = "Failed to connect to server.";
    }
});

// Create Team (Admin Only)
document.getElementById("createTeamForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById("teamNameCreate").value,
        description: document.getElementById("teamDescCreate").value
    };

    try {
        const res = await fetch("http://localhost:8080/teams", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        document.getElementById("createTeamMessage").textContent = res.ok
            ? "Team created successfully!"
            : "Failed to create team.";
        if (res.ok) {
            this.reset();
            loadTeams(); // refresh team list
        }
    } catch {
        document.getElementById("createTeamMessage").textContent = "Unable to connect to server.";
    }
});

// Load Teams (for Teams Page)
async function loadTeams() {
  const container = document.getElementById("teamsList");
  if (!container) return;

  container.innerHTML = "<p>Loading teams...</p>";

  try {
    const res = await fetch("http://localhost:8080/teams");
    const teams = await res.json();

    if (!Array.isArray(teams) || teams.length === 0) {
      container.innerHTML = "<p>No teams yet.</p>";
      return;
    }

    const getId = (t) => Number.isFinite(t?.id) ? t.id : null;

    container.innerHTML = teams.map(t => {
      const id = getId(t);
      return `
        <div class="team-card" style="background:#1b2b47; padding:1rem; border-radius:8px; border:1px solid #33415c;">
          <h3 style="color:#4a90e2;">${t.name ?? ''}</h3>
          <p>${t.description ?? "No description provided."}</p>
          <button class="join-btn" ${id == null ? "disabled" : ""} data-team-id="${id ?? ''}"
                  style="margin-top:0.5rem; background:#4a90e2; color:white; border:none; border-radius:6px; padding:0.5rem 1rem;">
            Request to Join
          </button>
          <div class="members" id="members-${id}" style="margin-top:0.75rem; font-size:0.95rem;">
            <em>${id == null ? "No id available" : "Loading members..."}</em>
          </div>
        </div>
      `;
    }).join("");

    // Fetch approved members for each team
    for (const t of teams) {
      const id = getId(t);
      if (id == null) continue;
      const box = document.getElementById(`members-${id}`);
      if (!box) continue;
      try {
        const mRes = await fetch(`http://localhost:8080/teams/${id}/members`);
        if (!mRes.ok) { box.innerHTML = "<em>No approved members yet.</em>"; continue; }
        const members = await mRes.json();
        box.innerHTML = (Array.isArray(members) && members.length)
          ? `<strong>Members:</strong> ${members.join(", ")}`
          : `<em>No approved members yet.</em>`;
      } catch {
        box.innerHTML = "<span style='color:#d9534f;'>Failed to load members.</span>";
      }
    }
  } catch {
    container.innerHTML = "<p style='color:red;'>Error loading teams.</p>";
  }

  // Attach once
  if (!container.dataset.joinHandlerBound) {
    container.addEventListener("click", async (e) => {
      const btn = e.target.closest(".join-btn");
      if (!btn || btn.disabled) return;

      const teamId = Number(btn.dataset.teamId);
      const username = localStorage.getItem("username")
        || document.getElementById("loginUsername")?.value;

      if (!Number.isFinite(teamId)) return alert("Invalid team id.");
      if (!username) return alert("Please log in before sending a join request.");

      btn.disabled = true; btn.textContent = "Sending...";
      try {
        const res = await fetch(`http://localhost:8080/teams/${teamId}/request`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });
        if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
        btn.textContent = "Request Sent";
      } catch (err) {
        console.error(err);
        alert("Join failed. See console for details.");
        btn.disabled = false; btn.textContent = "Request to Join";
      }
    });
    container.dataset.joinHandlerBound = "true";
  }
}

async function loadJoinRequests() {
  const box = document.getElementById("joinRequests");
  if (!box) return;
  box.innerHTML = "<p>Loading requests...</p>";

  try {
    const res = await fetch("http://localhost:8080/teams/requests/pending");
    if (!res.ok) throw new Error(await res.text());
    const reqs = await res.json();

    box.innerHTML = reqs.length ? "" : "<p>No pending requests.</p>";
    reqs.forEach(r => {
      box.insertAdjacentHTML("beforeend", `
        <div class="stat-card">
          <p><strong>${r.username}</strong> → Team ${r.team?.id ?? "?"}</p>
          <div style="margin-top:.5rem;">
            <button onclick="approveJoin(${r.id})">Approve</button>
            <button onclick="denyJoin(${r.id})" style="margin-left:.5rem;">Deny</button>
          </div>
        </div>
      `);
    });
  } catch (e) {
    console.error(e);
    box.innerHTML = "<p style='color:#d9534f;'>Failed to load requests.</p>";
  }
}


function requestToJoin(teamId, btnEl) {
  const id = Number(teamId);
  if (!Number.isFinite(id)) { alert("Invalid team id."); return; }

  const username = localStorage.getItem("username") || document.getElementById("loginUsername")?.value;
  if (!username) { alert("Please log in before sending a join request."); return; }

  const revert = () => { if (btnEl) { btnEl.disabled = false; btnEl.textContent = "Request to Join"; } };
  if (btnEl) { btnEl.disabled = true; btnEl.textContent = "Sending..."; }

  fetch(`http://localhost:8080/teams/${id}/request`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  })
  .then(async res => {
    if (res.ok) { if (btnEl) btnEl.textContent = "Request Sent"; }
    else {
      const msg = await res.text().catch(()=>"");
      alert(`Failed: ${res.status} ${msg || ""}`);
      revert();
    }
  })
  .catch(err => { console.error(err); alert("Network error."); revert(); });
}

// ✨ expose to inline onclick
window.requestToJoin = requestToJoin;

async function approveJoin(requestId) {
  try {
    const res = await fetch(`http://localhost:8080/teams/requests/${requestId}/approve`, { method: "PATCH" });
    if (res.ok) {
      alert("Request approved!");
      loadJoinRequests();
      loadTeams(); // 👈 refresh members list
    } else {
      alert("Failed to approve request.");
    }
  } catch {
    alert("Unable to process request.");
  }
}

async function denyJoin(requestId) {
  try {
    const res = await fetch(`http://localhost:8080/teams/requests/${requestId}/deny`, { method: "PATCH" });
    if (res.ok) {
      alert("Request denied.");
      loadJoinRequests();
      loadTeams(); // 👈 optional, in case you want to reflect any changes
    } else {
      alert("Failed to deny request.");
    }
  } catch {
    alert("Unable to process request.");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // Preload challenges so Home has fresh data
  loadChallenges?.();

  // Attach listeners only if the elements exist
  document.querySelector("a[href*='challenges']")?.addEventListener("click", loadChallenges);
  document.querySelector("a[href*='teams']")?.addEventListener("click", loadTeams);
  document.querySelector("a[href*='admin']")?.addEventListener("click", () => {
    loadPendingProblems?.();
    loadJoinRequests?.();
  });
});
</script>

</body>
</html>
 